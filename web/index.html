<!DOCTYPE html>
<html>

<head>
    <title>Image Labeler</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 20px;
            background: #e9ecef;
            min-height: 100vh;
        }

        .container {
            display: flex;
            gap: 20px;
            height: 85vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .sidebar {
            display: grid;
            grid-template-rows: auto auto 1fr auto;
            gap: 15px;
            width: 300px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 20px;
            flex: 1;
        }

        .filter-search {
            padding: 15px;
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
        }

        .filter-search h4 {
            margin: 0 0 10px 0;
            color: #667eea;
            font-size: 14px;
            font-weight: 600;
        }

        .filter-search input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }

        .filter-search input:focus {
            outline: none;
            border-color: #667eea;
        }

        .filter-search button {
            margin-top: 8px;
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .filter-search button:hover {
            background: #5568d3;
        }

        .autocomplete-dropdown {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            width: calc(100% - 20px);
            z-index: 1000;
        }

        .autocomplete-item {
            padding: 8px;
            cursor: pointer;
        }

        .autocomplete-item:hover {
            background: #f0f0f0;
        }

        .active-filters {
            padding: 15px;
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            min-height: 60px;
        }

        .active-filters h4 {
            margin: 0 0 10px 0;
            color: #667eea;
            font-size: 14px;
            font-weight: 600;
        }

        .filter-tag {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 12px;
            margin: 4px;
            border-radius: 16px;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(102,126,234,0.3);
        }

        .filter-tag .remove {
            margin-left: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .image-list {
            overflow-y: auto;
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            padding: 15px;
        }

        .image-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .image-list-header h4 {
            margin: 0;
            color: #667eea;
            font-size: 14px;
            font-weight: 600;
        }

        .refresh-btn {
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            cursor: pointer;
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            background: #667eea;
            color: white;
        }

        .pagination {
            padding: 15px;
            text-align: center;
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            font-size: 12px;
        }

        .pagination p {
            margin: 2px 0;
            font-size: 11px;
        }

        .pagination button {
            margin: 0 2px;
            padding: 2px 6px;
            font-size: 11px;
        }

        .selected-image {
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            overflow: hidden;
        }

        .labels-table-container {
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            text-align: center;
        }

        .upload-area {
            background: rgba(255,255,255,0.9);
            border: 2px dashed #c7d2fe;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #eef2ff;
        }

        .upload-report-area {
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
        }

        .upload-report-area h4 {
            margin: 0 0 10px 0;
            color: #667eea;
            font-size: 14px;
            font-weight: 600;
        }

        .image-item {
            padding: 10px;
            background: white;
            margin: 6px 0;
            cursor: pointer;
            font-size: 14px;
            height: 32px;
            box-sizing: border-box;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .image-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .delete-btn {
            background: rgba(102,126,234,0.1);
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 14px;
            padding: 4px 8px;
            margin-left: auto;
            border-radius: 4px;
            flex-shrink: 0;
            transition: all 0.2s;
            font-weight: 600;
        }

        .delete-btn:hover {
            background: #667eea;
            color: white;
        }

        .image-item:hover {
            background: #eef2ff;
            transform: translateX(4px);
        }

        .image-item.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102,126,234,0.4);
        }

        #imageDisplay {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .image-display {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
        }

        .labels-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .labels-table th,
        .labels-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .labels-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .pagination button {
            margin: 0 3px;
            padding: 6px 12px;
            border: 2px solid #e9ecef;
            background: white;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .pagination button:hover:not(:disabled) {
            background: #eef2ff;
            border-color: #667eea;
        }

        .pagination button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .pagination button:disabled {
            background: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
            border-color: #dee2e6;
        }

        .upload-button {
            background: #007cba;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .upload-button:hover {
            background: #005a8a;
        }

        .upload-report {
            margin-top: 15px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 5px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007cba;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .upload-icon {
            width: 80px;
            height: 80px;
            margin-bottom: 15px;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 5px;
            text-align: center;
        }
    </style>
</head>

<body>
    <div id="app"></div>

    <script src="https://unpkg.com/amazon-cognito-identity-js@6.3.12/dist/amazon-cognito-identity.min.js"></script>
    <script src="config.js"></script>
    <script>
        if (!window.APP_CONFIG) {
            alert('Configuration not loaded. Please check config.js');
            throw new Error('APP_CONFIG not found');
        }
        const API_BASE = window.APP_CONFIG.API_BASE;
        const USER_POOL_ID = window.APP_CONFIG.USER_POOL_ID;
        const USER_POOL_CLIENT_ID = window.APP_CONFIG.USER_POOL_CLIENT_ID;

        let images = [];
        let authToken = null;
        let cognitoUser = null;

        const poolData = { UserPoolId: USER_POOL_ID, ClientId: USER_POOL_CLIENT_ID };
        const userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);

        const originalFetch = window.fetch;
        window.fetch = async function (...args) {
            const response = await originalFetch(...args);
            if (response.status === 401) {
                const text = await response.clone().text();
                if (text.includes('expired') || text.includes('Unauthorized')) {
                    alert('Your session has expired. Please log in again.');
                    logout();
                }
            }
            return response;
        };

        function getConfidenceColor(confidence) {
            if (confidence < 50) {
                return 'rgb(139, 0, 0)';
            } else if (confidence <= 75) {
                const ratio = (confidence - 50) / 25;
                const red = Math.round(139 * (1 - ratio) + 255 * ratio);
                const green = Math.round(255 * ratio);
                return `rgb(${red}, ${green}, 0)`;
            } else {
                const ratio = (confidence - 75) / 25;
                const red = Math.round(255 * (1 - ratio));
                const green = Math.round(255 - 128 * ratio);
                return `rgb(${red}, ${green}, 0)`;
            }
        }

        function checkAuth() {
            cognitoUser = userPool.getCurrentUser();
            if (cognitoUser) {
                cognitoUser.getSession((err, session) => {
                    if (err || !session.isValid()) {
                        showLogin();
                    } else {
                        authToken = session.getIdToken().getJwtToken();
                        showApp();
                        loadImages();
                    }
                });
            } else {
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('app').innerHTML = `
                <div style="max-width: 400px; margin: 100px auto; padding: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <h2 style="color: white; margin-top: 0;">Image Labeling - Login</h2>
                    <form onsubmit="login(event)">
                        <div style="margin: 15px 0;">
                            <label style="color: white; font-size: 14px;">Email:</label><br>
                            <input type="email" id="email" required style="width: 100%; padding: 10px; margin: 8px 0; background: rgba(255,255,255,0.9); border: none; border-radius: 6px; box-sizing: border-box;">
                        </div>
                        <div style="margin: 15px 0;">
                            <label style="color: white; font-size: 14px;">Password:</label><br>
                            <input type="password" id="password" required style="width: 100%; padding: 10px; margin: 8px 0; background: rgba(255,255,255,0.9); border: none; border-radius: 6px; box-sizing: border-box;">
                        </div>
                        <button type="submit" style="width: 100%; padding: 12px; background: white; color: #667eea; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: 10px;">Login</button>
                    </form>
                    <div id="loginError" style="color: #ffe0e0; margin-top: 15px; font-size: 14px;"></div>
                </div>
            `;
        }

        function login(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            const authenticationData = { Username: email, Password: password };
            const authenticationDetails = new AmazonCognitoIdentity.AuthenticationDetails(authenticationData);
            const userData = { Username: email, Pool: userPool };
            cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);

            cognitoUser.authenticateUser(authenticationDetails, {
                onSuccess: (result) => {
                    authToken = result.getIdToken().getJwtToken();
                    showApp();
                    loadImages();
                },
                onFailure: (err) => {
                    document.getElementById('loginError').textContent = err.message;
                },
                newPasswordRequired: () => {
                    showNewPasswordForm();
                }
            });
        }

        function showNewPasswordForm() {
            document.getElementById('app').innerHTML = `
                <div style="max-width: 400px; margin: 100px auto; padding: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <h2 style="color: white; margin-top: 0;">Set New Password</h2>
                    <p style="color: rgba(255,255,255,0.9);">Please set a new password for your account.</p>
                    <form onsubmit="setNewPassword(event)">
                        <div style="margin: 15px 0;">
                            <label style="color: white; font-size: 14px;">New Password:</label><br>
                            <input type="password" id="newPassword" required style="width: 100%; padding: 10px; margin: 8px 0; background: rgba(255,255,255,0.9); border: none; border-radius: 6px; box-sizing: border-box;">
                        </div>
                        <button type="submit" style="width: 100%; padding: 12px; background: white; color: #667eea; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: 10px;">Set Password</button>
                    </form>
                    <div id="passwordError" style="color: #ffe0e0; margin-top: 15px; font-size: 14px;"></div>
                </div>
            `;
        }

        function setNewPassword(event) {
            event.preventDefault();
            const newPassword = document.getElementById('newPassword').value;

            cognitoUser.completeNewPasswordChallenge(newPassword, {}, {
                onSuccess: (result) => {
                    authToken = result.getIdToken().getJwtToken();
                    showApp();
                    loadImages();
                },
                onFailure: (err) => {
                    document.getElementById('passwordError').textContent = err.message;
                }
            });
        }

        function logout() {
            if (cognitoUser) cognitoUser.signOut();
            authToken = null;
            cognitoUser = null;
            showLogin();
        }

        function showApp() {
            document.getElementById('app').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h1 style="margin: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Image Labeler</h1>
                    <button onclick="logout()" style="padding: 10px 20px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; cursor: pointer; transition: transform 0.2s; box-shadow: 0 4px 12px rgba(245,87,108,0.3);" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">Logout</button>
                </div>
                <div class="container">
                    <div class="sidebar">
                        <div class="filter-search" style="position: relative;">
                            <h4>Filter Search Box</h4>
                            <input type="text" id="filterInput" placeholder="Search labels..." oninput="handleFilterInput(event)" onkeydown="handleFilterKeydown(event)">
                            <div id="autocompleteDropdown" class="autocomplete-dropdown" style="display: none;"></div>
                            <button onclick="addFilter()" style="margin-top: 5px; padding: 5px 10px;">Add Filter</button>
                        </div>
                        <div class="active-filters">
                            <h4>Active Filters</h4>
                            <div id="activeFilters">No filters active</div>
                        </div>
                        <div class="image-list" id=imageListContainer>
                            <div class="image-list-header">
                                <h4 id="imageListHeader">Images</h4>
                                <button class="refresh-btn" onclick="loadImages()" title="Refresh image list">&#8635;</button>
                            </div>
                            <div id="imageList">Loading...</div>
                        </div>
                        <div class="pagination">
                            <div id="paginationControls"></div>
                        </div>
                    </div>
                    <div class="main-content">
                        <div class="selected-image">
                            <div id="imageDisplay">Select an image</div>
                        </div>
                        <div class="labels-table-container" id="labelsDisplay">Select an image to view labels</div>
                        <div class="upload-area" id="uploadArea" onclick="triggerFileUpload()" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
                            <div id="uploadContent">
                                <svg class="upload-icon" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="20" y="35" width="60" height="50" rx="5" fill="none" stroke="#667eea" stroke-width="3"/>
                                    <path d="M 50 15 L 50 60" stroke="#667eea" stroke-width="3" stroke-linecap="round"/>
                                    <path d="M 35 30 L 50 15 L 65 30" fill="none" stroke="#667eea" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                                    <circle cx="35" cy="55" r="8" fill="#667eea" opacity="0.3"/>
                                    <path d="M 30 70 L 40 60 L 50 65 L 65 50 L 75 60 L 75 75 L 25 75 Z" fill="#667eea" opacity="0.3"/>
                                </svg>
                                <div>Click or drag files to upload</div>
                            </div>
                            <input type="file" id="fileInput" multiple accept=".jpg,.jpeg,.png,.gif" style="display: none;" onchange="handleFileUpload()">
                        </div>
                        <div class="upload-report-area">
                            <h4>Activity Log</h4>
                            <div id="activityLog" class="upload-report">No activity yet</div>
                        </div>
                    </div>
                </div>
            `;

            // Setup resize observer after DOM is ready
            setTimeout(() => {
                imagesPerPage = calculateImagesPerPage();
                setupResizeObserver();
            }, 100);
        }

        let currentPage = 0;
        let imagesPerPage = 10;
        let activeFilters = [];
        let imageLabels = {};
        let currentImageUrl = null;
        let totalPages = 0;
        let totalImages = 0;
        let resizeObserver = null;
        let selectedImageName = null;

        function logActivity(message, type = 'info') {
            const log = document.getElementById('activityLog');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#333';
            const entry = `<div style="color: ${color}; margin: 5px 0;"><strong>${timestamp}</strong> - ${message}</div>`;
            if (log.innerHTML === 'No activity yet') {
                log.innerHTML = entry;
            } else {
                log.innerHTML = entry + log.innerHTML;
            }
        }

        function calculateImagesPerPage() {
            const container = document.getElementById('imageListContainer');
            const header = document.querySelector('.image-list-header');
            if (!container || !header) return 1;

            const containerStyle = window.getComputedStyle(container);
            const padding = parseFloat(containerStyle.paddingTop) + parseFloat(containerStyle.paddingBottom);
            const availableHeight = container.clientHeight - header.offsetHeight - padding;
            const itemHeight = 35; // 32px height + 3px margin
            const calculatedItems = Math.floor(availableHeight / itemHeight);
            return Math.max(1, calculatedItems);
        }

        function setupResizeObserver() {
            const imageListContainer = document.querySelector('.image-list');
            if (!imageListContainer) return;

            if (resizeObserver) {
                resizeObserver.disconnect();
            }

            resizeObserver = new ResizeObserver(() => {
                const newImagesPerPage = calculateImagesPerPage();
                if (newImagesPerPage !== imagesPerPage) {
                    imagesPerPage = newImagesPerPage;
                    currentPage = 0;
                    loadImages();
                }
            });

            resizeObserver.observe(imageListContainer);
        }

        async function loadImages() {
            document.getElementById('imageList').innerHTML = 'Loading...';
            try {
                const filtersParam = activeFilters.length > 0 ? `&filters=${encodeURIComponent(activeFilters.join(','))}` : '';
                const response = await fetch(`${API_BASE}/images?page=${currentPage}&limit=${imagesPerPage}${filtersParam}`, {
                    headers: { 'Authorization': authToken }
                });
                const data = await response.json();
                images = data.images;
                totalPages = data.pagination.totalPages;
                totalImages = data.pagination.total;
                displayImageList();
                updatePagination();
            } catch (error) {
                let message = 'Unable to load images. ';
                if (error.message.includes('401') || error.message.includes('403')) {
                    message += 'Session expired.';
                } else if (error.message.includes('NetworkError') || !navigator.onLine) {
                    message += 'Network connection issue.';
                } else {
                    message += 'Server error.';
                }
                document.getElementById('imageList').innerHTML = message;
                logActivity(message, 'error');
            }
        }

        function displayImageList() {
            const listElement = document.getElementById('imageList');
            listElement.innerHTML = images.map(image =>
                `<div class="image-item" data-image="${image}">
                    <span class="image-name" onclick="selectImage('${image}')">${image}</span>
                    <button class="delete-btn" onclick="deleteImage('${image}')" title="Delete image">&times;</button>
                </div>`
            ).join('');

            const startIndex = currentPage * imagesPerPage + 1;
            const endIndex = Math.min(startIndex + images.length - 1, totalImages);
            const headerElement = document.getElementById('imageListHeader');
            headerElement.textContent = `Images (${startIndex}-${endIndex} of ${totalImages})`;

            if (selectedImageName) {
                if (images.includes(selectedImageName)) {
                    document.querySelector(`.image-item[data-image="${selectedImageName}"]`)?.classList.add('selected');
                } else {
                    selectedImageName = null;
                    if (currentImageUrl) {
                        URL.revokeObjectURL(currentImageUrl);
                        currentImageUrl = null;
                    }
                    document.getElementById('imageDisplay').innerHTML = 'Select an image';
                    document.getElementById('labelsDisplay').innerHTML = 'Select an image to view labels';
                }
            }
        }

        function updatePagination() {
            const paginationElement = document.getElementById('paginationControls');

            if (totalPages <= 1) {
                paginationElement.innerHTML = `<p>Total: ${totalImages} images</p>`;
                return;
            }

            const firstDisabled = currentPage === 0 ? 'disabled' : '';
            const lastDisabled = currentPage === totalPages - 1 ? 'disabled' : '';

            let controls = `
                <p>Total: ${totalImages} images</p>
                <button ${firstDisabled} onclick="changePage(0)">First</button>
                <button ${firstDisabled} onclick="changePage(${currentPage - 1})">&laquo;</button>
            `;

            for (let i = 0; i < totalPages; i++) {
                controls += `<button class="${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i + 1}</button>`;
            }

            controls += `
                <button ${lastDisabled} onclick="changePage(${currentPage + 1})">&raquo;</button>
                <button ${lastDisabled} onclick="changePage(${totalPages - 1})">Last</button>
            `;

            paginationElement.innerHTML = controls;
        }

        function changePage(page) {
            currentPage = page;
            loadImages();
        }

        let selectedSuggestionIndex = -1;
        let currentSuggestions = [];

        async function handleFilterInput(event) {
            const input = event.target.value.trim().toLowerCase();
            const dropdown = document.getElementById('autocompleteDropdown');

            if (input.length === 0) {
                dropdown.style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/suggest_filters?prefix=${encodeURIComponent(input)}`, {
                    headers: { 'Authorization': authToken }
                });
                const suggestions = await response.json();
                currentSuggestions = suggestions;
                selectedSuggestionIndex = -1;

                if (suggestions.length > 0) {
                    dropdown.innerHTML = suggestions.map((suggestion, index) =>
                        `<div class="autocomplete-item" data-index="${index}" onclick="selectSuggestion('${suggestion}')">${suggestion}</div>`
                    ).join('');
                    dropdown.style.display = 'block';
                } else {
                    dropdown.style.display = 'none';
                }
            } catch (error) {
                console.error('Error fetching suggestions:', error);
                dropdown.style.display = 'none';
            }
        }

        function handleFilterKeydown(event) {
            const dropdown = document.getElementById('autocompleteDropdown');
            const items = dropdown.querySelectorAll('.autocomplete-item');

            if (event.key === 'ArrowDown') {
                event.preventDefault();
                selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, items.length - 1);
                updateSelectedSuggestion(items);
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                updateSelectedSuggestion(items);
            } else if (event.key === 'Enter') {
                event.preventDefault();
                if (selectedSuggestionIndex >= 0 && currentSuggestions[selectedSuggestionIndex]) {
                    selectSuggestion(currentSuggestions[selectedSuggestionIndex]);
                } else {
                    addFilter();
                }
            } else if (event.key === 'Escape') {
                dropdown.style.display = 'none';
            }
        }

        function updateSelectedSuggestion(items) {
            items.forEach((item, index) => {
                item.style.background = index === selectedSuggestionIndex ? '#f0f0f0' : 'white';
            });
        }

        function selectSuggestion(suggestion) {
            document.getElementById('filterInput').value = suggestion;
            document.getElementById('autocompleteDropdown').style.display = 'none';
            addFilter();
        }

        function addFilter() {
            const filterText = document.getElementById('filterInput').value.trim().toLowerCase();
            if (filterText && !activeFilters.includes(filterText)) {
                activeFilters.push(filterText);
                updateActiveFilters();
                currentPage = 0;
                loadImages();
                document.getElementById('filterInput').value = '';
            }
        }

        function updateActiveFilters() {
            const filtersElement = document.getElementById('activeFilters');
            if (activeFilters.length === 0) {
                filtersElement.innerHTML = 'No filters active';
            } else {
                filtersElement.innerHTML = activeFilters.map(filter =>
                    `<span class="filter-tag">${filter}<span class="remove" onclick="removeFilter('${filter}')">&times;</span></span>`
                ).join('');
            }
        }

        function removeFilter(filter) {
            activeFilters = activeFilters.filter(f => f !== filter);
            updateActiveFilters();
            currentPage = 0;
            loadImages();
        }



        async function getAndDisplayLabels(imageName) {
            document.getElementById('labelsDisplay').innerHTML = '<div class="spinner"></div>';

            try {
                const response = await fetch(`${API_BASE}/labels/${imageName}`, {
                    headers: { 'Authorization': authToken }
                });
                const data = await response.json();

                if (data.labels && data.labels.length > 0) {
                    const tableHTML = `
                        <table class="labels-table">
                            <thead><tr><th>Label</th><th>Confidence</th></tr></thead>
                            <tbody>
                                ${data.labels.map(label => `
                                    <tr>
                                        <td>${label.name}</td>
                                        <td style="background-color: ${getConfidenceColor(label.confidence)}">${label.confidence.toFixed(1)}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                    document.getElementById('labelsDisplay').innerHTML = tableHTML;
                } else {
                    document.getElementById('labelsDisplay').innerHTML = 'No labels found';
                }
            } catch (error) {
                let message = 'Unable to load labels. ';
                if (error.message.includes('404')) {
                    message = 'No labels available for this image.';
                } else if (error.message.includes('401')) {
                    message += 'Please log in again.';
                } else {
                    message += 'Please try again.';
                }
                document.getElementById('labelsDisplay').innerHTML = message;
            }
        }

        async function getAndDisplayImage(imageName) {
            document.getElementById('imageDisplay').innerHTML = '<div class="spinner"></div>';

            try {
                const displayElement = document.getElementById('imageDisplay');
                const rect = displayElement.getBoundingClientRect();
                const maxWidth = Math.floor(rect.width);
                const maxHeight = Math.floor(rect.height);

                const response = await fetch(`${API_BASE}/image/${imageName}?maxwidth=${maxWidth}&maxheight=${maxHeight}`, {
                    headers: {
                        'Accept': 'image/jpeg,image/png,image/gif',
                        'Authorization': authToken
                    }
                });
                console.log('Response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const blob = await response.blob();
                console.log('Blob size:', blob.size, 'Type:', blob.type);

                if (blob.size === 0) {
                    throw new Error('Empty blob received');
                }

                if (!blob.type.startsWith('image/')) {
                    throw new Error('Unexpected blob type:', blob.type);
                }

                const imageUrl = URL.createObjectURL(blob);
                const img = document.createElement('img');
                img.className = 'image-display';

                img.onload = () => {
                    console.log('Image loaded successfully');
                };

                currentImageUrl = imageUrl;

                img.onerror = (e) => {
                    console.error('Image failed to display:', e);
                    console.log('Blob size:', blob.size, 'Type:', blob.type);
                    document.getElementById('imageDisplay').innerHTML = '<p>Failed to display image</p>';
                    URL.revokeObjectURL(imageUrl);
                };

                document.getElementById('imageDisplay').innerHTML = '';
                document.getElementById('imageDisplay').appendChild(img);
                img.src = imageUrl;
            } catch (error) {
                console.error('Error fetching image:', error);
                let message = 'Unable to display image. ';
                if (error.message.includes('404')) {
                    message += 'Image not found.';
                } else if (error.message.includes('401')) {
                    message += 'Please log in again.';
                } else {
                    message += 'Please try again.';
                }
                document.getElementById('imageDisplay').innerHTML = `<p>${message}</p>`;
            }
        }

        async function selectImage(imageName) {
            if (currentImageUrl) {
                URL.revokeObjectURL(currentImageUrl);
                currentImageUrl = null;
            }

            selectedImageName = imageName;
            document.querySelectorAll('.image-item').forEach(item => {
                item.classList.toggle('selected', item.dataset.image === imageName);
            });

            document.getElementById('imageDisplay').innerHTML = '<div class="spinner"></div>';
            document.getElementById('labelsDisplay').innerHTML = '<div class="spinner"></div>';

            try {
                await Promise.all([
                    getAndDisplayLabels(imageName),
                    getAndDisplayImage(imageName)
                ]);
            } catch (error) {
                console.error('Error displaying image or labels:', error);
            }
        }

        function triggerFileUpload() {
            document.getElementById('fileInput').click();
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('uploadArea').style.borderColor = '#007cba';
            document.getElementById('uploadArea').style.backgroundColor = '#f0f8ff';
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('uploadArea').style.borderColor = '#ddd';
            document.getElementById('uploadArea').style.backgroundColor = '#f9f9f9';
        }

        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('uploadArea').style.borderColor = '#ddd';
            document.getElementById('uploadArea').style.backgroundColor = '#f9f9f9';

            const files = event.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('fileInput').files = files;
                handleFileUpload();
            }
        }

        async function handleFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const files = Array.from(fileInput.files);
            if (files.length === 0) return;

            const uploadContent = document.getElementById('uploadContent');
            const uploadArea = document.getElementById('uploadArea');

            uploadArea.onclick = null;
            uploadContent.innerHTML = '<div class="spinner"></div><div style="margin-top: 10px;">Uploading...</div>';

            let successful = 0;
            let failed = 0;

            for (const file of files) {
                try {
                    const formData = new FormData();
                    formData.append('file', file);

                    const response = await fetch(`${API_BASE}/upload_image`, {
                        method: 'POST',
                        headers: { 'Authorization': authToken },
                        body: formData
                    });

                    if (response.ok) {
                        successful++;
                    } else {
                        failed++;
                        if (response.status === 413) {
                            logActivity(`Upload of ${file.name} failed due to file being too large`, 'error');
                        } else if (response.status === 401 || response.status === 403) {
                            logActivity(`Upload of ${file.name} failed due to authentication error`, 'error');
                        } else {
                            logActivity(`Upload of ${file.name} failed due to server error`, 'error');
                        }
                    }
                } catch (error) {
                    failed++;
                    if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                        logActivity(`Upload of ${file.name} failed due to network error`, 'error');
                    } else {
                        logActivity(`Upload of ${file.name} failed due to unexpected error`, 'error');
                    }
                }
            }

            if (failed > 0) {
                logActivity(`Failed to upload ${failed} image${failed > 1 ? 's' : ''}`, 'error');
            }
            if (successful > 0) {
                logActivity(`Uploaded ${successful} image${successful > 1 ? 's' : ''}`, 'success');
                loadImages();
            }

            fileInput.value = '';
            uploadArea.onclick = triggerFileUpload;
            uploadContent.innerHTML = `
                <svg class="upload-icon" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <rect x="20" y="35" width="60" height="50" rx="5" fill="none" stroke="#007cba" stroke-width="3"/>
                    <path d="M 50 15 L 50 60" stroke="#007cba" stroke-width="3" stroke-linecap="round"/>
                    <path d="M 35 30 L 50 15 L 65 30" fill="none" stroke="#007cba" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="35" cy="55" r="8" fill="#007cba" opacity="0.3"/>
                    <path d="M 30 70 L 40 60 L 50 65 L 65 50 L 75 60 L 75 75 L 25 75 Z" fill="#007cba" opacity="0.3"/>
                </svg>
                <div>Click or drag files to upload</div>
            `;
        }

        async function deleteImage(imageName) {
            if (!confirm(`Are you sure you want to delete "${imageName}"?\n\nThis action cannot be undone.`)) {
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = '<div class="modal-content"><div class="spinner"></div><div style="margin-top: 15px;">Deleting image...</div></div>';
            document.body.appendChild(modal);

            try {
                const response = await fetch(`${API_BASE}/image/${imageName}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': authToken }
                });

                if (response.ok) {
                    if (selectedImageName === imageName) {
                        selectedImageName = null;
                        if (currentImageUrl) {
                            URL.revokeObjectURL(currentImageUrl);
                            currentImageUrl = null;
                        }
                        document.getElementById('imageDisplay').innerHTML = 'Select an image';
                        document.getElementById('labelsDisplay').innerHTML = 'Select an image to view labels';
                    }
                    logActivity(`Deleted image: ${imageName}`, 'success');
                    loadImages();
                } else {
                    logActivity(`Failed to delete image: ${imageName}`, 'error');
                }
            } catch (error) {
                logActivity(`Error deleting image: ${imageName}`, 'error');
            } finally {
                document.body.removeChild(modal);
            }
        }

        document.addEventListener('click', (event) => {
            const dropdown = document.getElementById('autocompleteDropdown');
            const filterInput = document.getElementById('filterInput');
            if (dropdown && filterInput && !filterInput.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.style.display = 'none';
            }
        });

        checkAuth();
    </script>
</body>

</html>