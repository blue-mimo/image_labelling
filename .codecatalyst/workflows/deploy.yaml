Name: Deploy_Image_Labeling_Stack
SchemaVersion: "1.0"

Triggers:
  - Type: PUSH
    Branches:
      - main
  - Type: MANUAL

Actions:
  Deploy:
    Identifier: aws/build@v1.0.0
    Environment:
      Name: production
      Connections:
        - Name: default
          Role: CodeCatalystWorkflowDevelopmentRole-image-labelling
    Inputs:
      Sources:
        - WorkflowSource
    Configuration:
      Steps:
        - Run: |
            echo "Deploying CloudFormation stack..."
            aws cloudformation create-stack \
              --stack-name image-labeling-stack \
              --template-body file://cloudformation-template.yaml \
              --capabilities CAPABILITY_IAM \
              --region us-east-1 || \
            aws cloudformation update-stack \
              --stack-name image-labeling-stack \
              --template-body file://cloudformation-template.yaml \
              --capabilities CAPABILITY_IAM \
              --region us-east-1

            echo "Waiting for stack deployment to complete..."
            aws cloudformation wait stack-create-complete --stack-name image-labeling-stack --region us-east-1 || \
            aws cloudformation wait stack-update-complete --stack-name image-labeling-stack --region us-east-1

            echo "Deployment completed successfully!"
